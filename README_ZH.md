# RosMqttBridge

这个项目的目的是通过MQTT桥梁建立本地主机和IoT设备之间的双向通信。我们使用的IoT设备集成了ROS系统，并配备了一个摄像头，可以拍摄点云和图像数据。启用算法后，该设备可以处理这些数据并将其发布到本地ROS话题上。此设备还可以通过网络传输数据。由于IoT设备和本地主机的公网IP地址不确定，且需要传输大量数据，而且有的场景下网络环境不稳定，因此我们选择使用MQTT协议来实现它们的远距离数据传输。

## 架构图
![Alt text](<architecture.png>)


## Getting Started

该项目由三个主要部分组成：物联网设备、云平台和本地主机。程序分别在本地主机和设备上运行。

### Prerequisites

安装软件前需要准备的东西。

* 具有ROS和其他捕捉功能的设备。
* 具有公网IP的可靠云服务器。选择哪种云并不重要（如AWS EC2、阿里云ECS或腾讯云VM）。请将IP放在设备和服务器的配置类中。
* 本地主机应安装Linux环境和ROS。

### Installation


1. 按照[链接](https://mosquitto.org/download/)，在物联网设备、云和本地主机中正确安装Eclipse Mosquitto，并配置云系统中的防火墙，允许1883端口的入站流量。检查是否绑定到所有可用的网络接口，输入
   
```
$ netstat -an | grep 1883
tcp        0      0 0.0.0.0:1883            0.0.0.0:*               LISTEN  
```

## Test and Deploy

### IoT Device

在设备中，确保您已在主节点注册。注册完成后，将device文件夹中的文件克隆到您的物联网设备中，并在终端运行以下命令：

```
$ python3 vibot_device.py
```

该命令将启动程序并订阅命令主题，等待来自服务器的命令。它将定期发送心跳来表明设备还活着。

### Server Host

要在您的本地主机上开始工作，请将 host 文件夹中的文件克隆到您的主机上，然后在终端上运行以下命令：

```
$ python3 device_commander.py
```

该命令将检查设备是否存活。如果设备存活，您可以启用VIO算法并与物联网设备进行交互。

请注意，我们为一次传输的点云数据设置了上限，如果您需要传输更多的点云数据，您可以再次传输数据。您也可以根据需要修改上限。由于图像数据太大，无法在单个数据包中传输，因此我们将其分成多个数据包进行传输。您可以在数据处理器中合并这些数据包。

## 项目状态

本项目开放扩展。一些建议


* **数据处理器**： 如果您需要处理额外的数据，如保存、可视化或预处理，您可以根据需要修改数据处理器。

* **安全性**： 为了提高安全性，您可以设置身份验证和授权机制，以限制对 "status_check "和 "status_ok "消息的访问。您还可以实施TLS协议，并根据需要设置用户名和密码。

* **其他数据类型**： 如果您需要传输其他数据类型，如焦点长度和位置，您可以通过添加类似的转发器、MQTT主题和不同实现的数据处理器来扩展该项目。


## 需要注意的点

1. 设备有时出现错误： 无法在主节点注册。似乎不能通过杀死进程来重启roscore，只能重启，但有时重启一次不起作用，只能多重启几次，这个ROS没有想象中的稳定。
2. 程序的安全性需要注意
3. 极个别情况下，设备可以连接到互联网，但不能正常推送心跳，重启后就好了。




